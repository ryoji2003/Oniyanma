<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ç¦å³¶çœŒç«‹åšç‰©é¤¨ æ¤œå®šãƒ•ã‚§ã‚¹</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;700&family=Zen+Old+Mincho:wght@700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Noto Sans JP', sans-serif; background-color: #f8fafc; color: #1e293b; }
        .font-serif { font-family: 'Zen Old Mincho', serif; }
        .fade-in { animation: fadeIn 0.4s cubic-bezier(0.4, 0, 0.2, 1); }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .loader { border: 3px solid #e2e8f0; border-radius: 50%; border-top: 3px solid #1e3a8a; width: 24px; height: 24px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        input:focus, textarea:focus { outline: 2px solid #1e3a8a; outline-offset: 1px; background-color: #fff; }
        textarea { resize: none; }
        .pop-in { animation: popIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        @keyframes popIn { from { opacity: 0; transform: scale(0.9); } to { opacity: 1; transform: scale(1); } }
    </style>
    <script>
        tailwind.config = {
            theme: { extend: { colors: { museum: { blue: '#1e3a8a', gold: '#ca8a04', gray: '#334155', bg: '#f1f5f9', } } } }
        }
    </script>
</head>
<body class="min-h-screen flex flex-col items-center justify-center p-0 sm:p-4 bg-slate-100">

<div id="app" class="w-full sm:max-w-md h-[100dvh] sm:h-[750px] bg-white sm:rounded-3xl shadow-2xl overflow-hidden flex flex-col relative">
    <header id="app-header" class="bg-museum-blue text-white pt-10 pb-4 px-6 relative z-20 shadow-md transition-colors duration-500">
        <div class="flex justify-between items-end">
            <div>
                <p class="text-[10px] tracking-widest opacity-80 mb-1 uppercase">Fukushima Prefectural Museum</p>
                <h1 class="text-xl font-serif font-bold tracking-wide leading-tight">åšç‰©é¤¨æ¤œå®šãƒ•ã‚§ã‚¹</h1>
            </div>
            <div id="theme-badge" class="hidden text-[10px] font-bold bg-white/20 px-2 py-1 rounded backdrop-blur-sm border border-white/30">
                ãƒ†ãƒ¼ãƒï¼š<span id="header-theme-text"></span>
            </div>
        </div>
    </header>

    <main id="content" class="flex-grow overflow-y-auto bg-slate-50 relative"></main>

    <footer class="bg-white border-t border-slate-200 p-3 text-center relative z-20 flex justify-between items-center px-6">
        <p class="text-[10px] text-slate-400">&copy; 2026 Fukushima Museum</p>
        <button onclick="handleAdminLogin()" class="text-[10px] text-slate-300 hover:text-museum-blue transition-colors">Staff Only</button>
    </footer>
</div>

<script>
    const STATE = { currentTheme: 'èª­ã¿è¾¼ã¿ä¸­...', era: '', selectedTool: null, generatedQuiz: null };
    let allToolsCache = [];

    async function initApp() {
        try {
            const r = await fetch('/api/theme/current');
            STATE.currentTheme = r.ok ? await r.text() : "æœªè¨­å®š";
            render(renderHome);
        } catch (e) { STATE.currentTheme = "é€šä¿¡ã‚¨ãƒ©ãƒ¼"; render(renderHome); }
    }

    function render(fn, args) {
        document.getElementById('content').innerHTML = fn(args);
        document.getElementById('content').scrollTop = 0;
        const badge = document.getElementById('theme-badge');
        if (STATE.currentTheme !== 'æœªè¨­å®š' && STATE.currentTheme !== 'èª­ã¿è¾¼ã¿ä¸­...') {
            badge.classList.remove('hidden');
            document.getElementById('header-theme-text').innerText = STATE.currentTheme;
        } else badge.classList.add('hidden');
    }

    function updateHeaderColor(isDark) {
        const h = document.getElementById('app-header');
        if(isDark) { h.classList.remove('bg-museum-blue'); h.classList.add('bg-slate-900'); }
        else { h.classList.add('bg-museum-blue'); h.classList.remove('bg-slate-900'); }
    }

    // --- ç”»é¢ ---

    function renderHome() {
        updateHeaderColor(false);
        return `
            <div class="fade-in p-6 flex flex-col items-center justify-center min-h-full space-y-6">
                <div class="w-full bg-white rounded-2xl p-6 shadow-sm border border-slate-100 text-center space-y-4">
                    <div class="inline-flex items-center justify-center w-16 h-16 rounded-full bg-blue-50 text-museum-blue mb-2">
                        <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"></path></svg>
                    </div>
                    <h2 class="text-xl font-bold text-slate-800 font-serif">çŸ¥ã®æ¢ç©¶ã¸ã‚ˆã†ã“ã</h2>
                    <p class="text-sm text-slate-600 leading-relaxed text-left">
                        åšç‰©é¤¨ã®å±•ç¤ºç‰©ã«ã¯ã€ã¾ã èªã‚‰ã‚Œã¦ã„ãªã„ç‰©èªãŒã‚ã‚Šã¾ã™ã€‚<br>
                        ä»Šå¹´ã®ãƒ†ãƒ¼ãƒ<span class="font-bold text-museum-blue mx-1">ã€Œ${STATE.currentTheme}ã€</span>ã®è¦–ç‚¹ã§ã€ã‚ãªãŸã ã‘ã®ã€Œå•ã„ã€ã‚’è¦‹ã¤ã‘ã¦ãã ã•ã„ã€‚
                    </p>
                </div>
                <div class="w-full space-y-3">
                    <button onclick="handleUserStart()" class="w-full py-4 bg-museum-blue text-white font-bold rounded-xl shadow-lg shadow-blue-900/20 hover:bg-blue-900 hover:shadow-xl transition-all flex items-center justify-center group">
                        <span>ä½œå•ã«æŒ‘æˆ¦ã™ã‚‹</span>
                        <svg class="w-5 h-5 ml-2 group-hover:translate-x-1 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7l5 5m0 0l-5 5m5-5H6"></path></svg>
                    </button>
                    <button onclick="handleFetchQuizList(false)" class="w-full py-4 bg-white border-2 border-museum-blue text-museum-blue font-bold rounded-xl shadow-sm hover:bg-blue-50 transition-all flex items-center justify-center">
                        <span class="text-lg mr-2">ğŸ”¥</span>
                        <span>ã¿ã‚“ãªã®ã‚¯ã‚¤ã‚ºã«æŒ‘æˆ¦ï¼</span>
                    </button>
                </div>
            </div>`;
    }

    function renderCuratorDashboard() {
        updateHeaderColor(true);
        const inputValue = STATE.currentTheme === 'æœªè¨­å®š' ? '' : STATE.currentTheme;
        return `
            <div class="fade-in p-6 space-y-6">
                <div class="flex items-center justify-between">
                    <h2 class="text-lg font-bold text-slate-800 flex items-center"><span class="w-2 h-6 bg-slate-800 mr-2 rounded-full"></span>ç®¡ç†è¨­å®š</h2>
                    <button onclick="render(renderHome)" class="text-xs text-slate-500 underline hover:text-red-500">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
                </div>
                <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-200">
                    <p class="text-xs font-bold text-slate-400 uppercase tracking-wider mb-2">ç¾åœ¨ã®ãƒ•ã‚§ã‚¹ãƒ†ãƒ¼ãƒ</p>
                    <p class="text-3xl font-serif font-bold text-museum-blue border-b border-slate-100 pb-4 mb-4">${STATE.currentTheme}</p>
                    <label class="block text-sm font-bold text-slate-700 mb-2">ãƒ†ãƒ¼ãƒã‚’å¤‰æ›´ãƒ»æ›´æ–°</label>
                    <div class="space-y-3">
                        <input type="text" id="themeInput" placeholder="ä¾‹ï¼šé“å…·ã€è¾²æ¥­..." class="w-full p-4 bg-slate-50 border border-slate-200 rounded-xl outline-none focus:ring-2 focus:ring-slate-400 text-lg" value="${inputValue}" onkeydown="if(event.key==='Enter') handleThemeUpdate()">
                        <button onclick="handleThemeUpdate()" class="w-full py-3 bg-slate-800 text-white font-bold rounded-xl shadow hover:bg-slate-700 transition-colors">ãƒ†ãƒ¼ãƒã‚’ä¿å­˜ã™ã‚‹</button>
                    </div>
                </div>
                <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-200">
                     <p class="text-xs font-bold text-slate-400 uppercase tracking-wider mb-4">å‚åŠ è€…ã®æŠ•ç¨¿</p>
                    <button onclick="handleFetchQuizList(true)" class="w-full py-4 bg-white border-2 border-museum-blue text-museum-blue font-bold rounded-xl shadow-sm hover:bg-blue-50 transition-colors flex items-center justify-center">
                        <span class="mr-2">ğŸ“„ æŠ•ç¨¿ã•ã‚ŒãŸå•é¡Œãƒªã‚¹ãƒˆã‚’è¦‹ã‚‹</span>
                    </button>
                </div>
            </div>`;
    }

    function renderQuizList({ quizzes, isAdmin }) {
        updateHeaderColor(true);
        const backFn = isAdmin ? renderCuratorDashboard : renderHome;
        const title = isAdmin ? "æŠ•ç¨¿ä¸€è¦§ (ç®¡ç†ç”¨)" : "ã¿ã‚“ãªã®ã‚¯ã‚¤ã‚º (ãƒ—ãƒ¬ã‚¤ç”¨)";

        if (quizzes.length === 0) {
            return `
                <div class="fade-in p-6 flex flex-col h-full">
                    <button onclick="render(${backFn.name})" class="mb-4 text-slate-400 text-sm">< æˆ»ã‚‹</button>
                    <div class="text-center py-20 bg-slate-50 rounded-xl border border-dashed border-slate-300">
                        <p class="text-slate-400">ã¾ã æŠ•ç¨¿ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚</p>
                    </div>
                </div>`;
        }

        // â˜…å¤‰æ›´ç‚¹ï¼šç®¡ç†è€…ç”¨ã‚‚å…¨ã¦ã®æƒ…å ±ï¼ˆé¸æŠè‚¢ãƒ»æ­£è§£ãƒ»è§£èª¬ï¼‰ã‚’ã‚»ãƒƒãƒˆã§è¡¨ç¤º
        if (isAdmin) {
            return `
                <div class="fade-in p-6 pb-20">
                    <div class="flex items-center justify-between mb-6">
                        <h2 class="text-lg font-bold text-slate-800">${title}</h2>
                        <button onclick="render(${backFn.name})" class="text-sm text-museum-blue font-bold underline">æˆ»ã‚‹</button>
                    </div>
                    <div class="space-y-4">
                        ${quizzes.map((q, i) => `
                            <div class="bg-white p-5 rounded-xl shadow-sm border border-slate-200 text-left relative overflow-hidden">
                                <div class="absolute top-0 left-0 w-1 h-full bg-slate-400"></div>
                                <div class="flex justify-between items-start mb-2">
                                    <span class="text-[10px] bg-slate-100 px-2 py-0.5 rounded text-slate-500 font-bold">No.${i+1}</span>
                                </div>
                                <h3 class="font-bold text-slate-800 text-base mb-3 leading-relaxed">Q. ${q.question}</h3>

                                <div class="mb-3 pl-2 border-l-2 border-slate-100 space-y-1">
                                    ${q.choices.map((c, idx) => `
                                        <p class="text-xs ${c === q.answer ? 'text-green-600 font-bold' : 'text-slate-500'}">
                                            ${['ã‚¢','ã‚¤','ã‚¦','ã‚¨'][idx]}. ${c}
                                            ${c === q.answer ? ' âœ…' : ''}
                                        </p>
                                    `).join('')}
                                </div>

                                <div class="bg-green-50 px-3 py-2 rounded-lg border border-green-100 mb-2">
                                    <p class="text-xs text-green-700 font-bold">æ­£è§£: ${q.answer}</p>
                                </div>
                                <p class="text-[10px] text-slate-500 mt-2 leading-relaxed">è§£èª¬: ${q.explanation}</p>
                            </div>
                        `).join('')}
                    </div>
                </div>`;
        }

        // ä¸€èˆ¬å®¢ç”¨ï¼ˆãƒ—ãƒ¬ã‚¤ãƒ¢ãƒ¼ãƒ‰ï¼‰
        const listHtml = quizzes.map((q, i) => {
            const safeAnswer = q.answer.replace(/"/g, '&quot;');
            return `
                <div id="quiz-card-${i}" class="bg-white p-5 rounded-xl shadow-sm border border-slate-200 mb-6 relative overflow-hidden">
                    <div class="flex justify-between items-start mb-3">
                        <span class="text-[10px] bg-slate-100 px-2 py-0.5 rounded text-slate-500 font-bold">No.${i+1}</span>
                        <span id="status-${i}" class="text-xs font-bold"></span>
                    </div>
                    <h3 class="font-bold text-slate-800 text-lg mb-4 leading-relaxed">Q. ${q.question}</h3>
                    <div id="choices-area-${i}" class="grid gap-2 mb-2">
                        ${q.choices.map(c => `
                            <button onclick="checkAnswer(${i}, '${c.replace(/'/g, "\\'")}', '${safeAnswer}')"
                                class="w-full p-3 text-left bg-slate-50 border border-slate-200 rounded-lg hover:bg-blue-50 hover:border-museum-blue transition-colors text-sm font-bold text-slate-700">
                                ${c}
                            </button>
                        `).join('')}
                    </div>
                    <div id="explanation-area-${i}" class="hidden mt-4 pt-4 border-t border-slate-100 pop-in bg-slate-50 -mx-5 -mb-5 p-5">
                        <div class="mb-2"><span class="text-xs font-bold text-slate-400">æ­£è§£</span><p class="text-green-600 font-bold text-lg">${q.answer}</p></div>
                        <div class="text-sm text-slate-600 leading-relaxed"><span class="text-xs font-bold text-slate-400">è§£èª¬</span><br>${q.explanation}</div>
                    </div>
                </div>`;
        }).join('');

        return `
            <div class="fade-in p-6 pb-20">
                <div class="flex items-center justify-between mb-6">
                    <h2 class="text-lg font-bold text-slate-800">${title}</h2>
                    <button onclick="render(${backFn.name})" class="text-sm text-museum-blue font-bold underline">æˆ»ã‚‹</button>
                </div>
                <div>${listHtml}</div>
            </div>`;
    }

    function checkAnswer(index, selectedChoice, correctAnswer) {
        const card = document.getElementById(`quiz-card-${index}`);
        const status = document.getElementById(`status-${index}`);
        const explanation = document.getElementById(`explanation-area-${index}`);
        const choiceArea = document.getElementById(`choices-area-${index}`);
        if (!explanation.classList.contains('hidden')) return;

        const isCorrect = (selectedChoice === correctAnswer);
        if (isCorrect) {
            status.innerText = "â­• æ­£è§£ï¼";
            status.className = "text-xs font-bold text-green-600 bg-green-100 px-2 py-1 rounded";
            card.classList.add("ring-2", "ring-green-400");
        } else {
            status.innerText = "âŒ æ®‹å¿µ...";
            status.className = "text-xs font-bold text-red-600 bg-red-100 px-2 py-1 rounded";
            card.classList.add("ring-2", "ring-red-300");
        }
        const buttons = choiceArea.getElementsByTagName('button');
        for (let btn of buttons) {
            btn.disabled = true;
            btn.classList.add("opacity-50");
            if (btn.innerText.trim() === selectedChoice) {
                btn.classList.remove("opacity-50");
                btn.classList.add(isCorrect ? "bg-green-100" : "bg-red-100", isCorrect ? "border-green-400" : "border-red-400");
            }
        }
        explanation.classList.remove('hidden');
    }

    // --- å…±é€š ---
    function renderEraSelection() { updateHeaderColor(false); if(STATE.currentTheme==='æœªè¨­å®š')return `<div class="p-8 text-center">æº–å‚™ä¸­ã§ã™<br><button onclick="render(renderHome)" class="underline mt-4">æˆ»ã‚‹</button></div>`; return `<div class="fade-in p-6 pb-20"><h2 class="text-lg font-bold text-slate-800 font-serif mb-4">ã©ã®æ™‚ä»£ã®å±•ç¤ºã§ã™ã‹ï¼Ÿ</h2><div class="grid gap-3">${['åŸå§‹','å¤ä»£','ä¸­ä¸–','è¿‘ä¸–','è¿‘ãƒ»ç¾ä»£'].map(e=>`<button onclick="handleEraSelect('${e}')" class="w-full p-4 bg-white border border-slate-200 rounded-xl shadow-sm hover:border-museum-blue text-left flex justify-between"><span class="font-bold text-slate-700">${e}</span><span>></span></button>`).join('')}</div><div class="mt-8 text-center"><button onclick="render(renderHome)" class="text-xs text-slate-400">æˆ»ã‚‹</button></div></div>`; }
    function renderToolSelection(d) { return `<div class="fade-in p-6 pb-20"><button onclick="render(renderEraSelection)" class="mb-4 text-slate-400 text-sm">< æˆ»ã‚‹</button><h2 class="text-lg font-bold text-slate-800 font-serif mb-4">è³‡æ–™ã‚’é¸æŠ (${d.total}ä»¶)</h2><div class="grid grid-cols-2 gap-3 mb-6">${d.tools.map(t=>`<button onclick='handleToolSelectRaw(${JSON.stringify(t).replace(/'/g,"&#39;")})' class="bg-white p-3 rounded-xl border border-slate-200 shadow-sm hover:shadow-md text-left h-32 flex flex-col justify-between"><h3 class="font-bold text-slate-800 text-sm line-clamp-2">${t.name}</h3><p class="text-[10px] text-slate-400">é¸æŠ</p></button>`).join('')}</div><button onclick="renderToolSelectionWithShuffle()" class="w-full py-3 bg-white border border-museum-blue text-museum-blue font-bold rounded-full">ä»–ã®è³‡æ–™ã‚’è¦‹ã‚‹</button></div>`; }
    function renderToolDetail() { const t=STATE.selectedTool; return `<div class="fade-in flex flex-col h-full"><div class="h-48 bg-slate-200 flex items-center justify-center text-4xl">ğŸ–¼ï¸</div><div class="p-6 bg-white flex-grow rounded-t-3xl -mt-4 relative"><h2 class="text-2xl font-bold font-serif mb-4">${t.name}</h2><p class="text-sm text-slate-600 mb-8">${t.description.replace(/\n/g,'<br>')}</p><button onclick="handleStartQuizCreation()" class="w-full py-4 bg-museum-blue text-white font-bold rounded-xl shadow-lg">ã“ã®è³‡æ–™ã§å•é¡Œã‚’ä½œã‚‹</button><button onclick="renderToolSelectionWithShuffle()" class="w-full mt-3 py-3 text-sm text-slate-400">æˆ»ã‚‹</button></div></div>`; }
    function renderLoading() { return `<div class="fade-in h-full flex flex-col items-center justify-center p-6"><div class="loader mb-6"></div><p class="font-bold text-museum-blue">AIãŒä½œå•ä¸­...</p></div>`; }
    function renderQuizReview() { const q=STATE.generatedQuiz; return `<div class="fade-in p-6 pb-20"><div class="bg-white border border-museum-blue/20 rounded-2xl shadow-lg p-5 mb-6"><div class="flex justify-between items-center mb-2"><span class="text-xs font-bold text-museum-blue bg-blue-50 px-2 py-1 rounded">ç·¨é›†ãƒ¢ãƒ¼ãƒ‰</span><span class="text-[10px] text-slate-400">ã‚¿ãƒƒãƒ—ã—ã¦ä¿®æ­£ã§ãã¾ã™</span></div><label class="text-[10px] font-bold text-slate-400 block mb-1">å•é¡Œæ–‡</label><textarea id="edit-question" class="w-full p-2 bg-slate-50 border border-slate-200 rounded-lg font-bold text-lg text-slate-800 leading-relaxed mb-4 focus:ring-2 focus:ring-museum-blue outline-none" rows="3">${q.question}</textarea><label class="text-[10px] font-bold text-slate-400 block mb-1">é¸æŠè‚¢</label><div class="space-y-2 mb-6">${q.choices.map((c,i)=>`<div class="flex items-center gap-2"><span class="text-xs font-bold text-slate-400 w-4">${['ã‚¢','ã‚¤','ã‚¦','ã‚¨'][i]}</span><input type="text" id="edit-choice-${i}" value="${c}" class="flex-grow p-2 bg-slate-50 border border-slate-200 rounded-lg text-sm font-bold text-slate-700"><input type="radio" name="correct-choice" value="${i}" ${c===q.answer?'checked':''} class="w-5 h-5 accent-green-600"></div>`).join('')}</div><label class="text-[10px] font-bold text-slate-400 block mb-1">è§£èª¬</label><textarea id="edit-explanation" class="w-full p-3 bg-slate-50 border border-slate-200 rounded-lg text-xs text-slate-600 leading-relaxed focus:ring-2 focus:ring-museum-blue outline-none" rows="4">${q.explanation}</textarea></div><div class="flex gap-3"><button onclick="handleStartQuizCreation()" class="flex-1 py-3 border border-slate-300 rounded-xl font-bold text-slate-600 bg-white">å†ç”Ÿæˆ</button><button onclick="handlePostQuiz()" class="flex-1 py-3 bg-museum-blue text-white rounded-xl font-bold shadow-lg">ä¿®æ­£ã—ã¦æŠ•ç¨¿</button></div></div>`; }
    function renderComplete() { return `<div class="fade-in h-full flex flex-col items-center justify-center p-6 text-center"><div class="text-4xl mb-4">âœ…</div><h2 class="text-2xl font-bold font-serif mb-2">æŠ•ç¨¿å®Œäº†</h2><p class="text-sm text-slate-500 mb-8">ã‚ãªãŸã®ã€Œå•ã„ã€ãŒè¨˜éŒ²ã•ã‚Œã¾ã—ãŸã€‚</p><button onclick="location.reload()" class="px-8 py-3 bg-slate-800 text-white font-bold rounded-xl">ãƒˆãƒƒãƒ—ã«æˆ»ã‚‹</button></div>`; }

    // --- ãƒ­ã‚¸ãƒƒã‚¯ ---
    function handleAdminLogin() { if(prompt("Pass")==="admin") render(renderCuratorDashboard); }
    async function handleThemeUpdate() {
        const val=document.getElementById('themeInput').value; if(!val){alert("ãƒ†ãƒ¼ãƒã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");return;}
        try{ const r=await fetch('/api/theme/save',{method:'POST',body:val}); if(r.ok){STATE.currentTheme=val;alert('ãƒ†ãƒ¼ãƒã‚’æ›´æ–°ã—ã¾ã—ãŸ');render(renderHome);} else alert("å¤±æ•—"); } catch(e){alert("é€šä¿¡ã‚¨ãƒ©ãƒ¼");}
    }
    function handleUserStart() { render(renderEraSelection); }
    async function handleEraSelect(e) { STATE.era=e; STATE.selectedTool=null; render(renderLoading); const r=await fetch(`/api/tools/search?era=${encodeURIComponent(e)}`); if(r.ok){allToolsCache=await r.json();if(allToolsCache.length==0)return alert('ãªã—');renderToolSelectionWithShuffle();} }
    function renderToolSelectionWithShuffle() { render(renderToolSelection, { tools: [...allToolsCache].sort(()=>0.5-Math.random()).slice(0,6), total: allToolsCache.length }); }
    function handleToolSelectRaw(t) { STATE.selectedTool=t; render(renderToolDetail); }
    async function handleStartQuizCreation() {
        render(renderLoading);
        try { const r=await fetch('/api/quiz/generate',{method:'POST',body:STATE.selectedTool.name}); if(r.ok){STATE.generatedQuiz=await r.json();render(renderQuizReview);}else{alert('ã‚¨ãƒ©ãƒ¼');render(renderToolDetail);} } catch(e){alert('ã‚¨ãƒ©ãƒ¼');render(renderToolDetail);}
    }
    async function handlePostQuiz() {
        const q=document.getElementById('edit-question').value; const e=document.getElementById('edit-explanation').value; const c=[]; let idx=0;
        for(let i=0;i<4;i++){ c.push(document.getElementById(`edit-choice-${i}`).value); if(document.querySelector(`input[name="correct-choice"][value="${i}"]`).checked) idx=i; }
        try { const r=await fetch('/api/quiz/post',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({question:q,choices:c,answer:c[idx],explanation:e})}); if(r.ok)render(renderComplete); else alert("å¤±æ•—"); } catch(x){alert("ã‚¨ãƒ©ãƒ¼");}
    }
    async function handleFetchQuizList(isAdmin) {
        try { const r=await fetch('/api/quiz/list'); if(r.ok){const l=await r.json();render(renderQuizList,{quizzes:l,isAdmin:isAdmin});} else alert("å¤±æ•—"); } catch(e){alert("é€šä¿¡ã‚¨ãƒ©ãƒ¼");}
    }
    initApp();
</script>
</body>
</html>